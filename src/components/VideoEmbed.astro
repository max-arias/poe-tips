---
/**
 * VideoEmbed - Responsive YouTube video embed with lazy loading
 */

interface Props {
    url: string;
    title?: string;
    class?: string;
}

const { url, title = "Video", class: className } = Astro.props;

// Extract YouTube video ID from various URL formats
function getYouTubeId(url: string): string | null {
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?/]+)/,
        /youtube\.com\/shorts\/([^&?/]+)/,
    ];

    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    return null;
}

const videoId = getYouTubeId(url);
const thumbnailUrl = videoId
    ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`
    : null;
---

{
    videoId ? (
        <div class:list={["video-embed", className]} data-video-id={videoId}>
            <div class="video-facade">
                <img
                    src={thumbnailUrl}
                    alt={title}
                    loading="lazy"
                    class="video-thumbnail"
                />
                <button
                    type="button"
                    class="play-button"
                    aria-label={`Play ${title}`}
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </button>
            </div>
            <iframe
                class="video-iframe"
                src=""
                data-src={`https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`}
                title={title}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
            />
        </div>
    ) : (
        <div class:list={["video-embed video-error", className]}>
            <p>Unable to load video</p>
            <a href={url} target="_blank" rel="noopener noreferrer">
                Watch on YouTube
            </a>
        </div>
    )
}

<style>
    .video-embed {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .video-facade {
        position: absolute;
        inset: 0;
        cursor: pointer;
    }

    .video-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background-color: rgba(0, 0, 0, 0.7);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-fast);
    }

    .play-button:hover {
        background-color: var(--accent);
        transform: translate(-50%, -50%) scale(1.1);
    }

    .video-iframe {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: none;
    }

    .video-embed.loaded .video-facade {
        display: none;
    }

    .video-embed.loaded .video-iframe {
        display: block;
    }

    .video-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-xl);
        color: var(--text-secondary);
    }

    .video-error a {
        margin-top: var(--space-sm);
        color: var(--accent);
    }
</style>

<script>
    function initVideoEmbeds() {
        document.querySelectorAll(".video-embed").forEach((container) => {
            const facade = container.querySelector(".video-facade");
            const iframe = container.querySelector("iframe");

            if (!facade || !iframe) return;

            facade.addEventListener("click", () => {
                const src = iframe.dataset.src;
                if (src) {
                    iframe.src = src;
                    container.classList.add("loaded");
                }
            });
        });
    }

    initVideoEmbeds();
    document.addEventListener("astro:page-load", initVideoEmbeds);
</script>
