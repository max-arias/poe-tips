---
import Layout from "../layouts/Layout.astro";
import GameToggle from "../components/GameToggle.astro";
import SearchBar from "../components/SearchBar.astro";
import TagFilter from "../components/TagFilter.astro";
import TipCard from "../components/TipCard.astro";
import { getCollection } from "astro:content";

// Get all tips
const tips = await getCollection("tips");

// Sort by date (newest first)
const sortedTips = tips.sort(
	(a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime(),
);

// Extract unique tags for the filter
const allTags = [...new Set(tips.flatMap((tip) => tip.data.tags))].sort();
---

<Layout title="PoE Tips - Path of Exile Tips & Guides">
	<main class="main">
		<header class="header">
			<div class="container">
				<div class="header-content">
					<div class="branding">
						<h1 class="site-title">PoE Tips</h1>
						<p class="site-tagline">
							Tips & guides for Path of Exile
						</p>
					</div>
					<GameToggle />
				</div>
			</div>
		</header>

		<section class="filters-section">
			<div class="container">
				<SearchBar />
				<TagFilter tags={allTags.slice(0, 12)} />
			</div>
		</section>

		<section class="tips-section">
			<div class="container">
				<div class="tips-header">
					<h2 class="tips-count" id="tips-count">
						{sortedTips.length} tips
					</h2>
				</div>

				<div class="tips-list" id="tips-list">
					{
						sortedTips.length === 0 ? (
							<div class="empty-state">
								<p>No tips yet. Check back soon!</p>
							</div>
						) : (
							sortedTips.map((tip) => (
								<TipCard
									title={tip.data.title}
									description={tip.data.description}
									slug={tip.id}
									category={tip.data.category}
									tags={tip.data.tags}
									patchVersion={tip.data.patchVersion}
									game={tip.data.game}
									mayBeOutdated={tip.data.mayBeOutdated}
									difficulty={tip.data.difficulty}
									videoUrl={tip.data.videoUrl}
									source={tip.data.source}
									estimatedValue={tip.data.estimatedValue}
								/>
							))
						)
					}
				</div>

				<div class="no-results" id="no-results">
					<p>No tips match your search criteria.</p>
					<button
						type="button"
						class="btn btn-secondary"
						id="reset-filters"
					>
						Reset Filters
					</button>
				</div>
			</div>
		</section>
	</main>
</Layout>

<style>
	.main {
		min-height: 100vh;
	}

	.header {
		position: sticky;
		top: 0;
		z-index: 100;
		background-color: var(--bg-primary);
		border-bottom: 1px solid var(--border);
		padding: var(--space-md) 0;
	}

	.header-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
		gap: var(--space-md);
	}

	.branding {
		display: flex;
		flex-direction: column;
	}

	.site-title {
		font-size: var(--text-2xl);
		font-weight: 700;
		color: var(--accent);
		margin: 0;
	}

	.site-tagline {
		font-size: var(--text-sm);
		color: var(--text-muted);
		margin: 0;
	}

	.filters-section {
		padding: var(--space-lg) 0;
		background-color: var(--bg-secondary);
		border-bottom: 1px solid var(--border);
	}

	.filters-section .container {
		display: flex;
		flex-direction: column;
		gap: var(--space-lg);
	}

	.tips-section {
		padding: var(--space-xl) 0;
	}

	.tips-header {
		margin-bottom: var(--space-lg);
	}

	.tips-count {
		font-size: var(--text-sm);
		font-weight: 500;
		color: var(--text-muted);
		margin: 0;
	}

	.tips-list {
		display: flex;
		flex-direction: column;
		gap: var(--space-md);
	}

	.empty-state,
	.no-results {
		text-align: center;
		padding: var(--space-2xl);
		color: var(--text-muted);
	}

	.no-results {
		display: none;
	}

	.no-results.visible {
		display: block;
	}

	.no-results button {
		margin-top: var(--space-md);
	}

	@media (max-width: 640px) {
		.header-content {
			flex-direction: column;
			align-items: flex-start;
		}
	}
</style>

<script>
	import Fuse from "fuse.js";
	import abbreviationsData from "../data/abbreviations.json";

	interface TipData {
		element: HTMLElement;
		game: string;
		category: string;
		tags: string[];
		title: string;
		description: string;
	}

	interface FilterState {
		game: string;
		query: string;
		expandedTerms: string[];
		categories: string[];
		tags: string[];
	}

	function initFiltering() {
		const tipsList = document.getElementById("tips-list");
		const tipsCountEl = document.getElementById("tips-count");
		const noResultsEl = document.getElementById("no-results");
		const resetBtn = document.getElementById("reset-filters");

		if (!tipsList || !tipsCountEl || !noResultsEl) return;

		// Build tip data for filtering
		const tipCards = tipsList.querySelectorAll<HTMLElement>(".tip-card");
		const tips: TipData[] = Array.from(tipCards).map((el) => ({
			element: el,
			game: el.dataset.game || "both",
			category: el.dataset.category || "",
			tags: (el.dataset.tags || "").split(",").filter(Boolean),
			title: el.querySelector(".card-title")?.textContent || "",
			description:
				el.querySelector(".card-description")?.textContent || "",
		}));

		// Initialize Fuse for fuzzy search
		const fuse = new Fuse(tips, {
			keys: ["title", "description", "tags", "category"],
			threshold: 0.4,
			ignoreLocation: true,
			includeScore: true,
		});

		// Build abbreviation map
		const abbrMap = new Map<string, string>();
		abbreviationsData.abbreviations.forEach((item) => {
			abbrMap.set(item.abbr.toLowerCase(), item.full);
		});

		// Filter state
		const state: FilterState = {
			game: "both",
			query: "",
			expandedTerms: [],
			categories: [],
			tags: [],
		};

		// Listen for events
		window.addEventListener("game-changed", ((e: CustomEvent) => {
			state.game = e.detail.game;
			applyFilters();
		}) as EventListener);

		window.addEventListener("search-changed", ((e: CustomEvent) => {
			state.query = e.detail.query;
			state.expandedTerms = e.detail.expandedTerms;
			applyFilters();
		}) as EventListener);

		window.addEventListener("filter-changed", ((e: CustomEvent) => {
			state.categories = e.detail.categories;
			state.tags = e.detail.tags;
			applyFilters();
		}) as EventListener);

		// Reset button
		resetBtn?.addEventListener("click", () => {
			// Clear search
			const searchInput = document.getElementById(
				"search-input",
			) as HTMLInputElement;
			if (searchInput) {
				searchInput.value = "";
				document
					.getElementById("search-container")
					?.classList.remove("has-value");
			}

			// Clear filters
			document.getElementById("clear-all-filters")?.click();

			state.query = "";
			state.expandedTerms = [];
			state.categories = [];
			state.tags = [];
			applyFilters();
		});

		function applyFilters() {
			let visibleCount = 0;
			let matchedTips = tips;

			// Text search with fuzzy matching
			if (state.query || state.expandedTerms.length > 0) {
				const searchTerms =
					state.expandedTerms.length > 0
						? state.expandedTerms
						: [state.query.toLowerCase()];

				// Search with all expanded terms
				const results = new Set<TipData>();
				searchTerms.forEach((term) => {
					if (!term) return;
					const fuseResults = fuse.search(term);
					fuseResults.forEach((r) => results.add(r.item));
				});

				matchedTips = results.size > 0 ? [...results] : [];
			}

			// Apply filters to each tip
			tips.forEach((tip) => {
				let visible = matchedTips.includes(tip);

				// Game filter
				if (visible && state.game !== "both") {
					visible = tip.game === state.game || tip.game === "both";
				}

				// Category filter (OR logic - match any)
				if (visible && state.categories.length > 0) {
					visible = state.categories.includes(tip.category);
				}

				// Tag filter (AND logic - match all)
				if (visible && state.tags.length > 0) {
					visible = state.tags.every((tag) => tip.tags.includes(tag));
				}

				tip.element.classList.toggle("hidden", !visible);
				if (visible) visibleCount++;
			});

			// Update count and no-results state
			tipsCountEl.textContent = `${visibleCount} tip${visibleCount !== 1 ? "s" : ""}`;
			noResultsEl.classList.toggle(
				"visible",
				visibleCount === 0 && tips.length > 0,
			);
		}
	}

	initFiltering();
	document.addEventListener("astro:page-load", initFiltering);
</script>
